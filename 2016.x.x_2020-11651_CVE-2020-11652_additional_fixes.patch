From 9215159fc4281f9b9d149e26ace00e9e30b2d98a Mon Sep 17 00:00:00 2001
From: "Gareth J. Greenaway" <gareth@saltstack.com>
Date: Tue, 5 May 2020 16:49:51 -0700
Subject: [PATCH] Adding in missing fixes as part of CVE-2020-11651 and
 CVE-2020-11652

---
 salt/auth/__init__.py | 2 ++
 salt/master.py        | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/salt/auth/__init__.py b/salt/auth/__init__.py
index 2f03ce71c7..fe0d49a7b0 100644
--- a/salt/auth/__init__.py
+++ b/salt/auth/__init__.py
@@ -173,6 +173,8 @@ class LoadAuth(object):
         not valid
         '''
         t_path = os.path.join(self.opts['token_dir'], tok)
+        if not salt.utils.verify.clean_path(self.opts['token_dir'], t_path):
+            return {}
         if not os.path.isfile(t_path):
             return {}
         with salt.utils.fopen(t_path, 'rb') as fp_:
diff --git a/salt/master.py b/salt/master.py
index b4f9242f73..466e48775a 100644
--- a/salt/master.py
+++ b/salt/master.py
@@ -853,6 +853,8 @@ class MWorker(SignalHandlingMultiprocessingProcess):
         log.trace('Clear payload received with command %s', load['cmd'])
         cmd = load['cmd']
         method = self.clear_funcs.get_method(cmd)
+        if not method:
+            return {}, {'fun': 'send_clear'}
         return method(load), {'fun': 'send_clear'}
 
     def _handle_aes(self, data):
-- 
2.26.2

